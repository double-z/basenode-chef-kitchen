#!/bin/bash
#

DISABLE_FILE="/root/.ran_firstboot"

# If the node is restarted, don't rerun
if [ -e $DISABLE_FILE ]; then
        exit 0
fi

AUTOSTART=`curl -s http://169.254.169.254/latest/user-data | egrep '^:autostart: ' | cut -d ' ' -f 2`

if [ "$AUTOSTART" != "true" ]; then
	exit 0
fi

touch $DISABLE_FILE

LOGFILE="<%= @log_file %>"
AUTOSTART_DIR="<%= @autostart_dir %>"
AUTOSTART_FILES=`ls $AUTOSTART_DIR/`

# Ensure the log file is not readable (may contain secrets)
touch $LOGFILE
chmod 0600 $LOGFILE

cd $AUTOSTART_DIR
for FILE in $AUTOSTART_FILES; do
	echo ">> Running autostart file $FILE" >> $LOGFILE

	./$FILE >> $LOGFILE 2>&1
	if [ $? -ne 0 ]; then
		echo ">> Quitting autostart early due to failure" >> $LOGFILE
		break
	fi
done


# Local Variables:
# mode: sh
# End:
